<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>WhatsApp Scheduler</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<div class="container">
    <h1>Mensaje Programado</h1>

    <!-- MENSAJE -->
    <div class="card center">
        <label>Mensaje</label>

        <textarea
            id="message"
            rows="4"
            placeholder="Escribí el mensaje...">
        </textarea>

        <div class="center-button">
            <button onclick="saveMessage()">Guardar mensaje</button>
        </div>

        <div id="status-message" class="status"></div>
    </div>

    <!-- HORARIO -->
    <div class="card center">
        <label>Hora de envío</label>

        <div class="time-row">
            <input type="number" id="hour" min="0" max="23" placeholder="HH">
            <span>:</span>
            <input type="number" id="minute" min="0" max="59" placeholder="MM">
        </div>

        <button onclick="saveSchedule()">Guardar horario</button>
        <div id="status-schedule" class="status"></div>
    </div>

    <!-- DESTINATARIOS -->
    <div class="card center">
        <label>Destinatarios WhatsApp</label>

        <div class="add-recipient">
            <input
                type="text"
                id="recipient-input"
                placeholder="whatsapp:+5491132524633"
            >
            <button onclick="addRecipient()">Agregar</button>
        </div>

        <ul id="recipient-list"></ul>

        <button class="secondary" onclick="saveRecipients()">Guardar destinatarios</button>
        <div id="status-recipients" class="status"></div>
    </div>
</div>

<script>
    const message = document.getElementById("message");
    const hour = document.getElementById("hour");
    const minute = document.getElementById("minute");
    const recipientInput = document.getElementById("recipient-input");
    const recipientList = document.getElementById("recipient-list");

    let recipients = [];

    function showStatus(id, text, ok = true) {
        const el = document.getElementById(id);
        el.textContent = text;
        el.className = "status " + (ok ? "success" : "error");

        setTimeout(() => {
            el.textContent = "";
            el.className = "status";
        }, 3000);
    }

    function renderRecipients() {
        recipientList.innerHTML = "";
        recipients.forEach((num, index) => {
            const li = document.createElement("li");
            li.innerHTML = `
                <span>${num}</span>
                <button onclick="removeRecipient(${index})">✕</button>
            `;
            recipientList.appendChild(li);
        });
    }

    function addRecipient() {
        const value = recipientInput.value.trim();
        if (!value) return;

        recipients.push(value);
        recipientInput.value = "";
        renderRecipients();
    }

    function removeRecipient(index) {
        recipients.splice(index, 1);
        renderRecipients();
    }

    async function loadConfig() {
        try {
            const res = await fetch("/api/get-config");
            const data = await res.json();

            if (!data.error) {
                message.value = data.message || "";
                hour.value = data.send_hour ?? "";
                minute.value = data.send_minute ?? "";
                recipients = data.recipients || [];
                renderRecipients();
            }
        } catch {
            showStatus("status-message", "Error cargando datos", false);
        }
    }

    async function saveMessage() {
        try {
            await fetch("/api/set-config", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: message.value })
            });
            showStatus("status-message", "Mensaje guardado");
        } catch {
            showStatus("status-message", "Error al guardar", false);
        }
    }

    async function saveSchedule() {
        try {
            await fetch("/api/set-config", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    send_hour: hour.value,
                    send_minute: minute.value
                })
            });
            showStatus("status-schedule", "Horario guardado");
        } catch {
            showStatus("status-schedule", "Error al guardar", false);
        }
    }

    async function saveRecipients() {
        try {
            await fetch("/api/set-recipients", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ recipients })
            });
            showStatus("status-recipients", "Destinatarios guardados");
        } catch {
            showStatus("status-recipients", "Error al guardar", false);
        }
    }

    loadConfig();
</script>

</body>
</html>
